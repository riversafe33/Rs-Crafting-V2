<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Menú de Crafteo</title>
  <style>
    :root {
      --fondo: rgba(30, 20, 10, 0.95);
      --borde: #caa76f;
      --texto: #966f3dce;
      --titulo: #966f3dce;
      --boton: #caa76f;
      --boton-hover: rgba(156, 112, 60, 0.829);
      --cerrar: #000000a4;
      --cerrar-hover: #383635b7;
    }

    body {
      margin: 0;
      font-family: 'Georgia', serif;
      color: var(--texto);
    }

    .hidden {
      display: none !important;
    }

    #crafting-container {
      position: absolute;
      top: 3%;
      right: 2%;
      width: 37.5%;
      height: 80vh;
      background: var(--fondo);
      border: 4px solid var(--borde);
      border-radius: 20px;
      padding: 20px;
      box-shadow: 0 0 30px #000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .menu-header {
      text-align: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .menu-header h1 {
      font-size: 2em;
      margin: 0;
      color: var(--titulo);
    }

    .menu-header p {
      font-size: 1em;
      color: var(--texto);
    }

    .category-list {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 10px;
      flex-shrink: 0;
    }

    .category-btn {
      background: var(--boton);
      border: none;
      border-radius: 10px;
      padding: 8px 16px;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .category-btn:hover {
      background: var(--boton-hover);
    }

    #items-grid {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 10px;
      align-items: flex-start;
    }

    #items-grid::-webkit-scrollbar {
      width: 8px;
    }

    #items-grid::-webkit-scrollbar-track {
      background: transparent;
    }

    #items-grid::-webkit-scrollbar-thumb {
      background-color: var(--borde);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }

   .item-card {
      background: #3a2c1d;
      border: 2px solid var(--borde);
      border-radius: 15px;
      padding: 15px;
      text-align: center;
      transition: transform 0.3s ease;
      width: 100%;
      max-width: 300px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      font-size: 0.6em;
      font-family: 'Arial', 'Helvetica', sans-serif;
    }

    .item-card:hover {
      transform: scale(1.05);
    }

    .item-image {
      width: 96px;
      height: 96px;
      object-fit: contain;
      margin: 0 auto 10px auto;
      display: block;
    }

    .quantity-input {
      padding: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
      border-radius: 6px;
      border: 1px solid #966f3d;
      background: #2e2116;
      color: #ffffff;
      margin-top: auto;
    }

    .quantity-input::-webkit-outer-spin-button,
    .quantity-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .craft-btn {
      margin-top: 10px;
      padding: 8px;
      font-size: 14px;
      width: 100%;
      border-radius: 6px;
      background: #caa76f;
      color: #2e2116;
      border: none;
      cursor: pointer;
    }

    .craft-btn:hover {
      background: var(--boton-hover);
    }

    .toggle-ingredients-btn {
      background: var(--boton);
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s ease;
      color: #2e2116;
    }

    .toggle-ingredients-btn:hover {
      background: var(--boton-hover);
    }

    #ingredients-panel {
      position: absolute;
      top: 75%;
      transform: translate(-50%, -50%);
      left: 40%;
      background: var(--fondo);
      border: 4px solid var(--borde);
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 0 20px #000;
      z-index: 999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      max-width: 600px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Arial', 'Helvetica', sans-serif;
    }

    #ingredients-panel.hidden {
      display: none;
    }

    .ingredients-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 10px;
    }

    #ingredients-title {
      color: var(--titulo);
      font-size: 1.2em;
      margin: 0;
    }

    #close-ingredients-btn {
      background: var(--borde);
      border: none;
      color: var(--cerrar);
      font-size: 0.8em;
      padding: 2px 5px;
      border-radius: 6px;
      cursor: pointer;
      margin-left: auto;
      transform: translate(6px, -6px);
    }


    #close-ingredients-btn:hover {
      background: var(--cerrar-hover);
    }

    .materials {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 10px;
      margin-top: 10px;
      width: 100%;
      max-width: 440px;
    }

    .material {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      width: 100px;
      font-size: 1.0em;
      text-align: center;
    }

    .material img {
      width: 60px;
      height: 60px;
      margin-bottom: 4px;
    }

    .material::after {
      content: attr(data-count);
      position: absolute;
      top: -4px;
      right: -4px;
      color: var(--texto);
      font-size: 1.2em;
      padding: 2px 4px;
      border-radius: 6px;
      pointer-events: none;
    }

    #close-btn {
      margin-top: 10px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      padding: 10px 30px;
      background: var(--cerrar);
      border: 2px solid var(--texto);
      border-radius: 10px;
      font-size: 1em;
      cursor: pointer;
      color: var(--texto);
    }

    #close-btn:hover {
      background: var(--cerrar-hover);
    }

    .container-prompmenu,
    .container-prompprop {
      position: absolute;
      right: 2%;
      top: 92%;
      transform: translateY(-50%);
      width: 150px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.8);
      border: 2px solid var(--boton-hover);
      border-radius: 15px;
      box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 1000;
    }

    .title-prompmenu,
    .title-prompprop {
      font-size: 18px;
      font-weight: bold;
      color: var(--boton-hover);
      margin: 0;
      word-wrap: break-word;
    }

    #crafting-progress {
      position: absolute;
      bottom: 5%;
      left: 50%;
      transform: translateX(-50%);
      width: 20%;
      text-align: center;
      z-index: 9999;
    }

    .progress-text {
      font-size: 1em;
      color: var(--boton-hover);
      margin-bottom: 3px;
      font-weight: bold;
    }

    .progress-bar {
      width: 100%;
      height: 10px;
      background: #222;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--boton);
      transition: width 0.1s linear;
    }
  </style>
</head>
<body>
  <div id="crafting-container" class="hidden">
    <div class="menu-header">
      <h1 id="craftingMenuTitle"></h1>
      <p id="selectCategoryText"></p>
    </div>
    <div id="category-buttons" class="category-list"></div>
    <div id="items-grid"></div>
    <button id="close-btn"></button>
  </div>

  <div id="ingredients-panel" class="hidden">
  <div class="ingredients-header">
    <h3 id="ingredients-title"></h3>
    <button id="close-ingredients-btn">✖</button>
  </div>
    <div id="ingredients-list" class="materials"></div>
  </div>

  <div class="container-prompmenu">
    <div class="title-prompmenu" id="prompmenuText"></div>
  </div>

  <div class="container-prompprop">
    <div class="title-prompprop" id="promppropText"></div>
  </div>

  <div id="crafting-progress" class="hidden">
    <div class="progress-text" id="craftingProgressText"></div>
    <div class="progress-bar">
      <div class="progress-fill"></div>
    </div>
  </div>

  <script>
    let currentCategories = {};
    let progressInterval;
    let prompt = {};

    function createItemCard(item) {
      const card = document.createElement("div");
      card.className = "item-card";

      card.innerHTML = `
        <img src="${item.image}" class="item-image" />
        <h2>${item.label}</h2>
        <input type="number" min="1" placeholder="${prompt.quantityPlaceholder || 'Cantidad'}" class="quantity-input" />
        <button class="craft-btn">${prompt.craftButton || 'Craftear'}</button>
        <button class="toggle-ingredients-btn">${prompt.ingredientsButton || 'Ingredientes'}</button>
      `;

      card.querySelector(".craft-btn").addEventListener("click", () => {
        const quantity = card.querySelector(".quantity-input").value;
        fetch(`https://${GetParentResourceName()}/craftItem`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            item: item.value,
            quantity: quantity
          })
        });
        document.getElementById("crafting-container").classList.add("hidden");
        document.getElementById("ingredients-panel").classList.add("hidden");
      });

      const toggleBtn = card.querySelector(".toggle-ingredients-btn");
      toggleBtn.addEventListener("click", () => {
        const panel = document.getElementById("ingredients-panel");
        const title = document.getElementById("ingredients-title");
        const list = document.getElementById("ingredients-list");

        title.textContent = item.label;
        list.innerHTML = item.descriptionimages.map(mat => `
          <div class="material" data-count="${mat.count}">
            <img src="${mat.src}" />
            <span>${mat.text}</span>
          </div>
        `).join("");

        panel.classList.remove("hidden");
      });

      return card;
    }

    window.addEventListener('message', function (event) {
      const data = event.data;

      if (data.prompt) {
        prompt = data.prompt;
        applyPromptTexts();
      }

      if (data.type === 'showProgressBar') {
        const bar = document.getElementById('crafting-progress');
        const fill = bar.querySelector('.progress-fill');
        bar.classList.remove('hidden');
        fill.style.width = '0%';

        let elapsed = 0;
        const duration = data.duration;

        clearInterval(progressInterval);
        progressInterval = setInterval(() => {
          elapsed += 100;
          const percent = Math.min((elapsed / duration) * 100, 100);
          fill.style.width = percent + '%';
          if (percent >= 100) {
            clearInterval(progressInterval);
          }
        }, 100);
      }

      if (data.type === 'hideProgressBar') {
        document.getElementById('crafting-progress').classList.add('hidden');
        clearInterval(progressInterval);
      }

      if (data.type === "openCraftingMenuGrouped") {
        const container = document.getElementById("crafting-container");
        const categoryButtons = document.getElementById("category-buttons");
        const grid = document.getElementById("items-grid");

        categoryButtons.innerHTML = "";
        grid.innerHTML = "";
        container.classList.remove("hidden");

        currentCategories = data.categories;

        for (const category of Object.keys(currentCategories)) {
          const btn = document.createElement("button");
          btn.className = "category-btn";
          btn.textContent = category.charAt(0).toUpperCase() + category.slice(1);
          btn.addEventListener("click", () => showCategoryItems(category));
          categoryButtons.appendChild(btn);
        }

        if (data.defaultCategory && currentCategories[data.defaultCategory]) {
          showCategoryItems(data.defaultCategory);
        }
      }

      if (data.type === 'openCraftingMenuDirect') {
        const container = document.getElementById("crafting-container");
        const grid = document.getElementById("items-grid");
        const categoryButtons = document.getElementById("category-buttons");

        container.classList.remove("hidden");
        grid.innerHTML = "";
        categoryButtons.innerHTML = "";

        const items = data.items;
        items.forEach(item => {
          const card = createItemCard(item);
          grid.appendChild(card);
        });
      }

      if (data.type === 'showPrompmenu') {
        document.getElementById('prompmenuText').textContent = data.text || '';
        document.querySelector('.container-prompmenu').style.display = 'block';
      }

      if (data.type === 'hidePrompmenu') {
        document.querySelector('.container-prompmenu').style.display = 'none';
      }

      if (data.type === 'showProp') {
        document.getElementById('promppropText').textContent = data.text || '';
        document.querySelector('.container-prompprop').style.display = 'block';
      }

      if (data.type === 'hideProp') {
        document.querySelector('.container-prompprop').style.display = 'none';
      }
    });

    function applyPromptTexts() {
      document.getElementById('craftingMenuTitle').textContent = prompt.craftingMenu || 'Menú de Crafteo';
      document.getElementById('selectCategoryText').textContent = prompt.selectCategory || 'Selecciona una categoría';
      document.getElementById('close-btn').textContent = prompt.close || 'Cerrar';
      const progressText = document.getElementById('craftingProgressText');
      if (progressText) {
        progressText.textContent = prompt.crafting || 'Crafteando...';
      }
    }

    function showCategoryItems(category) {
      const grid = document.getElementById("items-grid");
      grid.innerHTML = "";

      const items = currentCategories[category];
      items.forEach(item => {
        const card = createItemCard(item);
        grid.appendChild(card);
      });
    }

    document.getElementById("close-btn").addEventListener("click", () => {
      document.getElementById("crafting-container").classList.add("hidden");
      document.getElementById("ingredients-panel").classList.add("hidden");
      fetch(`https://${GetParentResourceName()}/closeMenu`, {
        method: 'POST'
      });
    });

    document.getElementById("close-ingredients-btn").addEventListener("click", () => {
      document.getElementById("ingredients-panel").classList.add("hidden");
    });

  </script>
</body>
</html>